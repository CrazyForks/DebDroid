#!/bin/sh
# debinit: DebDroid bootstrap script
# Automatically applies commonly-used patches and fixes

# Check if the user has root permissions 
if [ "$(id -u)" -ne 0 ]; then
    echo "$0: Missing required super-user permisions."
    exit 1
fi

# Loads the debdroid environment file
# shellcheck disable=SC1091
. /sdcard/debdroid/environment

# Logs script activity to /tmp/init.log
if [ -z "$DEBDROID_INIT" ]; then
  export DEBDROID_INIT=1
  # shellcheck disable=SC2068
  exec sh -c 'exec "$0" $@ 2>&1 | tee /tmp/debinit.log' "$0" $@
fi

if ! getent group inet > /dev/null 2>&1; then
    groupadd -g 3003 inet
fi

# Fixes apt's networking issue
if ! id -nG _apt > /dev/null 2>&1 | grep -qw inet; then
    usermod -g inet _apt
fi

# Creates missing runtime folders
for dir in /run/ssh /run/dbus; do
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
        chmod 755 "$dir"
    fi
done

if command -v dbus-daemon >/dev/null 2>&1; then
    rm -f /run/dbus/pid
    dbus-daemon --system --fork
else
    echo "$0: Failed to start system DBus."
    echo "Install the \"dbus-x11\" and re-launch the environment"
fi
